<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dance Fluidity Feedback</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 1rem; }
  h1 { margin-bottom: 0.5rem; }
  p { margin: 0.2rem 0 1rem 0; font-size: 1rem; }
  #smoothnessBar { width: 80%; height: 20px; background: #ddd; margin: 10px auto; border-radius: 10px; overflow: hidden; }
  #fill { height: 100%; width: 0%; background: #4caf50; transition: width 0.1s; }
  #canvas { border: 1px solid #333; margin: 10px auto; display: block; background: #f9f9f9; }
</style>
</head>
<body>

<h1>Dance Fluidity Feedback</h1>
<p>Tap anywhere to start. Smooth = calm tone, jerky = higher tone.</p>

<div id="smoothnessBar"><div id="fill"></div></div>
<canvas id="canvas" width="300" height="300"></canvas>

<script>
let audioCtx, oscillator, gainNode;
let started = false;
let accBuffer = [];
const WINDOW_SIZE = 25;
const alpha = 0.2;
const baseFreq = 220;
const maxFreq = 880;
const fill = document.getElementById("fill");

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let trail = [];
const TRAIL_LENGTH = 100;
const SCALE = 15;
const jerkScale = 3;
const MIN_JERK = 0.08;  // deadzone for small noise
const alphaHP = 0.8;    // high-pass filter coefficient

let lastRaw = {x:0, y:0, z:0};
let accHP = {x:0, y:0, z:0};
let smoothVariancePrev = 0;

// --- Draw trail ---
function drawTrail() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.beginPath();
    for (let i=0; i<trail.length; i++) {
        let p = trail[i];
        if (i===0) ctx.moveTo(p.x,p.y);
        else ctx.lineTo(p.x,p.y);
    }
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
}

// --- Devicemotion handler ---
function handleMotion(event) {
    if (!event.accelerationIncludingGravity) return;

    let ax = event.accelerationIncludingGravity.x || 0;
    let ay = event.accelerationIncludingGravity.y || 0;
    let az = event.accelerationIncludingGravity.z || 0;

    // --- High-pass filter to remove gravity / slow drift ---
    accHP.x = alphaHP * (accHP.x + ax - lastRaw.x);
    accHP.y = alphaHP * (accHP.y + ay - lastRaw.y);
    accHP.z = alphaHP * (accHP.z + az - lastRaw.z);

    lastRaw = {x: ax, y: ay, z: az};

    let jerk = Math.sqrt(accHP.x**2 + accHP.y**2 + accHP.z**2) * jerkScale;

    // Deadzone to ignore tiny movements
    if (jerk < MIN_JERK) jerk = 0;

    // --- Rolling buffer ---
    accBuffer.push(jerk);
    if (accBuffer.length > WINDOW_SIZE) accBuffer.shift();

    let mean = accBuffer.reduce((a,b)=>a+b,0)/accBuffer.length;
    let variance = accBuffer.reduce((a,b)=>a+(b-mean)**2,0)/accBuffer.length;

    // --- Smooth variance ---
    let smoothVariance = alpha*variance + (1-alpha)*smoothVariancePrev;
    smoothVariancePrev = smoothVariance;

    // --- Audio ---
    if (started) {
        let targetFreq = baseFreq + Math.min(smoothVariance*200, maxFreq - baseFreq);
        oscillator.frequency.value = alpha*targetFreq + (1-alpha)*oscillator.frequency.value;
    }

    // --- Smoothness bar ---
    let pct = Math.min(1, smoothVariance / 5); 
    fill.style.width = (pct*100)+'%';
    fill.style.background = `rgb(${Math.floor(pct*255)},${Math.floor((1-pct)*200)},0)`;

    // --- Trail ---
    let pos = {
        x: canvas.width/2 + ax*SCALE*5,
        y: canvas.height/2 - ay*SCALE*5
    };
    trail.push(pos);
    if (trail.length > TRAIL_LENGTH) trail.shift();
    drawTrail();
}

// --- Initialize ---
async function init() {
    // Request motion permission on iOS/Android if needed
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const response = await DeviceMotionEvent.requestPermission();
            if (response !== 'granted') {
                alert("Motion permission denied.");
                return;
            }
        } catch (err) {
            alert("Motion permission error: " + err);
            return;
        }
    }

    // Audio setup
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    oscillator = audioCtx.createOscillator();
    gainNode = audioCtx.createGain();
    oscillator.type = 'sine';
    gainNode.gain.value = 0.1;
    oscillator.connect(gainNode).connect(audioCtx.destination);
    oscillator.start();
    started = true;

    // Start motion listener
    window.addEventListener('devicemotion', handleMotion);
}

// --- Start on tap ---
document.body.addEventListener('click', () => {
    init();
});
</script>

</body>
</html>
